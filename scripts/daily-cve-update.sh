#!/bin/bash
#
# Daily CVE Update Script for EC2
# Pulls latest repos from Bitbucket and runs npm audit on all
#
# Usage: ./daily-cve-update.sh
#
# Add to crontab for daily execution:
#   0 2 * * * /path/to/daily-cve-update.sh >> /var/log/cve-update.log 2>&1
#
# Required environment variables:
#   CVE_BB_TOKEN - Bitbucket API token
#
# EC2 Setup:
#   1. Set up SSH key for Bitbucket access
#   2. Export CVE_BB_TOKEN in /etc/environment or ~/.bashrc
#   3. Add this script to crontab
#

set -e

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
LOG_FILE="/var/log/cve-update.log"

# Use home directory appropriate for the user
REPOS_DIR="${REPOS_DIR:-$HOME/repos}"

echo "================================================"
echo "CVE Daily Update - $(date)"
echo "================================================"

# Check for required token
if [ -z "$CVE_BB_TOKEN" ]; then
    echo "Error: CVE_BB_TOKEN environment variable not set"
    exit 1
fi

# Step 1: Clone/Update repos from Bitbucket
echo ""
echo "Step 1: Updating repositories from Bitbucket..."
echo "------------------------------------------------"
"$SCRIPT_DIR/clone-all-bitbucket-repos.sh" "$REPOS_DIR"

# Step 2: Run npm audit on all repos
echo ""
echo "Step 2: Running npm audit on all repositories..."
echo "-------------------------------------------------"
"$SCRIPT_DIR/update-audits.sh" "$REPOS_DIR"

# Step 3: Generate summary
echo ""
echo "Step 3: Generating vulnerability summary..."
echo "--------------------------------------------"

OUTPUT_DIR="$SCRIPT_DIR/../data/npm-audits"
TOTAL_VULNS=0
CRITICAL=0
HIGH=0
MODERATE=0
LOW=0

for json_file in "$OUTPUT_DIR"/*.json; do
    if [ -f "$json_file" ]; then
        vulns=$(jq -r '.metadata.vulnerabilities // empty' "$json_file" 2>/dev/null)
        if [ -n "$vulns" ]; then
            c=$(echo "$vulns" | jq -r '.critical // 0')
            h=$(echo "$vulns" | jq -r '.high // 0')
            m=$(echo "$vulns" | jq -r '.moderate // 0')
            l=$(echo "$vulns" | jq -r '.low // 0')
            t=$(echo "$vulns" | jq -r '.total // 0')

            CRITICAL=$((CRITICAL + c))
            HIGH=$((HIGH + h))
            MODERATE=$((MODERATE + m))
            LOW=$((LOW + l))
            TOTAL_VULNS=$((TOTAL_VULNS + t))
        fi
    fi
done

echo ""
echo "=== VULNERABILITY SUMMARY ==="
echo "Total vulnerabilities: $TOTAL_VULNS"
echo "  Critical: $CRITICAL"
echo "  High:     $HIGH"
echo "  Moderate: $MODERATE"
echo "  Low:      $LOW"
echo ""
echo "Audit data saved to: $OUTPUT_DIR"
echo ""
echo "CVE Update completed at $(date)"
echo "================================================"
