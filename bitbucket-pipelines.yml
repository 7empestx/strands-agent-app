# Bitbucket Pipelines for MrRobot AI Core
# Deploys to ECS Fargate (primary) and EC2 (legacy)

image:
  name: 246295362269.dkr.ecr.us-east-1.amazonaws.com/mrrobot-pipelines-prod:latest
  aws:
    oidc-role: arn:aws:iam::246295362269:role/prod/mrrobot-ecs-prod

definitions:
  caches:
    pre-commit: ~/.cache/pre-commit
    pip: ~/.cache/pip
    docker: ~/.docker

  services:
    docker:
      memory: 2048

  steps:
    - step: &pre-commit
        oidc: true
        name: "Pre-commit Checks"
        image: python:3.11-slim
        caches:
          - pre-commit
          - pip
        script:
          - apt-get update && apt-get install -y git
          - pip install pre-commit
          - pre-commit run --all-files

    - step: &python-lint
        oidc: true
        name: "Python Lint & Test"
        image: python:3.11-slim
        caches:
          - pip
        script:
          - pip install -r requirements.txt
          - pip install flake8 pytest
          - flake8 .
          # - pytest  # Uncomment when tests are added

    - step: &deploy-ec2
        oidc: true
        name: "Deploy to EC2 (App Only)"
        caches:
          - pip
        script:
          - echo "Deploying app to EC2 (MCP server NOT restarted)..."
          # Install rsync if not available
          - which rsync || (yum install -y rsync 2>/dev/null || apt-get update && apt-get install -y rsync)
          # Configure SSH
          - mkdir -p ~/.ssh
          - echo "$EC2_SSH_KEY" | base64 -d > ~/.ssh/streamlit-key.pem
          - chmod 600 ~/.ssh/streamlit-key.pem
          # Sync code to EC2 (EXCLUDING mcp-servers to avoid accidental restarts)
          - |
            rsync -avz --delete \
              --exclude='.git' \
              --exclude='venv' \
              --exclude='__pycache__' \
              --exclude='*.pyc' \
              --exclude='.env' \
              --exclude='node_modules' \
              --exclude='infra' \
              --exclude='mcp-servers' \
              -e "ssh -i ~/.ssh/streamlit-key.pem -o StrictHostKeyChecking=no" \
              ./ ec2-user@$EC2_IP:/opt/mrrobot-ai-core/
          # Install dependencies and restart ONLY Streamlit (not MCP)
          - |
            ssh -i ~/.ssh/streamlit-key.pem -o StrictHostKeyChecking=no ec2-user@$EC2_IP << 'EOF'
              cd /opt/mrrobot-ai-core
              python3.11 -m pip install -r requirements.txt --quiet
              sudo systemctl restart streamlit
              echo "Streamlit restarted (MCP server unchanged)"
            EOF
          - echo "Deploy complete! MCP connections preserved."

    - step: &deploy-mcp
        oidc: true
        name: "Deploy MCP Server (Will Disconnect Clients)"
        caches:
          - pip
        script:
          - echo "⚠️  Deploying MCP server - clients will need to reconnect..."
          # Install rsync if not available
          - which rsync || (yum install -y rsync 2>/dev/null || apt-get update && apt-get install -y rsync)
          # Configure SSH
          - mkdir -p ~/.ssh
          - echo "$EC2_SSH_KEY" | base64 -d > ~/.ssh/streamlit-key.pem
          - chmod 600 ~/.ssh/streamlit-key.pem
          # Sync ONLY mcp-servers folder
          - |
            rsync -avz \
              -e "ssh -i ~/.ssh/streamlit-key.pem -o StrictHostKeyChecking=no" \
              ./mcp-servers/ ec2-user@$EC2_IP:/opt/mrrobot-ai-core/mcp-servers/
          # Restart MCP server
          - |
            ssh -i ~/.ssh/streamlit-key.pem -o StrictHostKeyChecking=no ec2-user@$EC2_IP << 'EOF'
              cd /opt/mrrobot-ai-core
              python3.11 -m pip install -r requirements.txt --quiet
              sudo systemctl restart mcp-server
              echo "MCP server restarted - clients need to reconnect"
            EOF
          - echo "MCP deploy complete! Users need to toggle MCP in their IDE."

    - step: &deploy-cdk
        oidc: true
        name: "Deploy CDK Infrastructure"
        caches:
          - node
        script:
          - cd infra
          - npm ci
          - npx cdk synth
          - npx cdk deploy --all --require-approval never

    # ==========================================================================
    # ECS FARGATE DEPLOYMENT
    # ==========================================================================
    - step: &build-docker-images
        oidc: true
        name: "Build & Push Docker Images"
        services:
          - docker
        caches:
          - docker
        script:
          - echo "Building Docker images for ECS Fargate..."
          - export AWS_REGION="us-east-1"
          - export AWS_ACCOUNT_ID="720154970215"
          - export REGISTRY="${AWS_ACCOUNT_ID}.dkr.ecr.${AWS_REGION}.amazonaws.com"
          # Authenticate with ECR
          - aws ecr get-login-password --region $AWS_REGION | docker login --username AWS --password-stdin $REGISTRY
          # Build Streamlit image
          - echo "Building Streamlit image..."
          - docker build -f Dockerfile.streamlit -t $REGISTRY/mrrobot-streamlit:latest -t $REGISTRY/mrrobot-streamlit:$BITBUCKET_COMMIT .
          # Build MCP Server image
          - echo "Building MCP Server image..."
          - docker build -f Dockerfile.mcp -t $REGISTRY/mrrobot-mcp-server:latest -t $REGISTRY/mrrobot-mcp-server:$BITBUCKET_COMMIT .
          # Verify Flask is installed (prevent the missing dependency issue)
          - echo "Verifying Flask is in MCP image..."
          - docker run --rm $REGISTRY/mrrobot-mcp-server:latest pip list | grep -i flask || (echo "ERROR: Flask not found in image!" && exit 1)
          # Push images
          - echo "Pushing images to ECR..."
          - docker push $REGISTRY/mrrobot-streamlit:latest
          - docker push $REGISTRY/mrrobot-streamlit:$BITBUCKET_COMMIT
          - docker push $REGISTRY/mrrobot-mcp-server:latest
          - docker push $REGISTRY/mrrobot-mcp-server:$BITBUCKET_COMMIT
          - echo "Docker images pushed successfully!"

    - step: &deploy-ecs
        oidc: true
        name: "Deploy to ECS Fargate"
        script:
          - echo "Deploying to ECS Fargate..."
          - export AWS_REGION="us-east-1"
          - export CLUSTER_NAME="mrrobot-ai-core"
          # Update Streamlit service
          - echo "Updating Streamlit service..."
          - aws ecs update-service --cluster $CLUSTER_NAME --service mrrobot-streamlit --force-new-deployment --region $AWS_REGION > /dev/null
          # Update MCP Server service
          - echo "Updating MCP Server service..."
          - aws ecs update-service --cluster $CLUSTER_NAME --service mrrobot-mcp-server --force-new-deployment --region $AWS_REGION > /dev/null
          - echo "ECS services updated! Waiting for deployment to stabilize..."
          # Wait for services to stabilize (optional, adds ~2-3 min)
          - aws ecs wait services-stable --cluster $CLUSTER_NAME --services mrrobot-streamlit mrrobot-mcp-server --region $AWS_REGION || echo "Warning: Services may still be deploying"
          - echo "ECS deployment complete!"
          - echo "  Streamlit: http://ai-agent.mrrobot.dev"
          - echo "  MCP Server: https://mcp.mrrobot.dev/sse"

options:
  size: 4x
  runtime:
    cloud:
      atlassian-ip-ranges: true

pipelines:
  # Run on all branches (lint only)
  branches:
    "**":
      - parallel:
          - step: *pre-commit
          - step: *python-lint

    # Deploy to ECS on main branch (primary deployment)
    main:
      - parallel:
          - step: *pre-commit
          - step: *python-lint
      - step: *build-docker-images
      - step: *deploy-ecs

  # Manual triggers
  custom:
    # ECS Deployments (Primary)
    deploy-ecs:
      - step: *build-docker-images
      - step: *deploy-ecs

    deploy-ecs-images-only:
      - step: *build-docker-images

    # Infrastructure
    deploy-infrastructure:
      - step: *deploy-cdk

    # EC2 Deployments (Legacy)
    deploy-ec2:
      - step: *deploy-ec2

    deploy-ec2-mcp:
      - step: *deploy-mcp

    # Full deployment (Infrastructure + ECS)
    full-deploy:
      - step: *deploy-cdk
      - step: *build-docker-images
      - step: *deploy-ecs
