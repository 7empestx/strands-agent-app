# Bitbucket Pipelines for MrRobot AI Core
# Deploys to ECS Fargate in dev (720154970215) and prod (246295362269) accounts

image: atlassian/default-image:4

clone:
  depth: 1

definitions:
  caches:
    pre-commit: ~/.cache/pre-commit
    pip: ~/.cache/pip
    node: ~/.npm

  services:
    docker:
      memory: 2048

  steps:
    - step: &pre-commit
        name: "Pre-commit Checks"
        image: python:3.11-slim
        caches:
          - pre-commit
          - pip
        script:
          - apt-get update && apt-get install -y git
          - pip install pre-commit
          - pre-commit run --all-files

    - step: &python-lint
        name: "Python Lint & Test"
        image: python:3.11-slim
        caches:
          - pip
        script:
          - pip install -r requirements.txt
          - pip install flake8 pytest
          - flake8 .

    - step: &build-docker-images-dev
        name: "Build & Push Docker Images (Dev)"
        services:
          - docker
        script:
          - echo "Building Docker images for ECS Fargate (DEV)..."
          - curl -s "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "awscliv2.zip" && unzip -q awscliv2.zip && ./aws/install
          - export AWS_REGION="us-east-1"
          - export AWS_ACCOUNT_ID="720154970215"
          - export REGISTRY="${AWS_ACCOUNT_ID}.dkr.ecr.${AWS_REGION}.amazonaws.com"
          - export AWS_ACCESS_KEY_ID=$AWS_DEV_ID
          - export AWS_SECRET_ACCESS_KEY=$AWS_DEV_SECRET
          - aws ecr get-login-password --region $AWS_REGION | docker login --username AWS --password-stdin $REGISTRY
          - echo "Building MCP Server image (includes React dashboard)..."
          # Try multiple NPM token variables (different repos use different names)
          - |
            if [ -n "$JFROG_TOKEN" ]; then
              export NPM_BUILD_TOKEN="$JFROG_TOKEN"
              echo "Using JFROG_TOKEN"
            elif [ -n "$NPM_DEVOPS_AUTH_TOKEN" ]; then
              export NPM_BUILD_TOKEN="$NPM_DEVOPS_AUTH_TOKEN"
              echo "Using NPM_DEVOPS_AUTH_TOKEN"
            elif [ -n "$NPM_AUTH_TOKEN" ]; then
              export NPM_BUILD_TOKEN="$NPM_AUTH_TOKEN"
              echo "Using NPM_AUTH_TOKEN"
            elif [ -n "$NPM_TOKEN" ]; then
              export NPM_BUILD_TOKEN="$NPM_TOKEN"
              echo "Using NPM_TOKEN"
            else
              echo "ERROR: No NPM token found!"
              exit 1
            fi
            echo "Token length: ${#NPM_BUILD_TOKEN}"
          - docker build -f Dockerfile.mcp --build-arg NPM_TOKEN="$NPM_BUILD_TOKEN" -t $REGISTRY/mrrobot-mcp-server:latest -t $REGISTRY/mrrobot-mcp-server:$BITBUCKET_COMMIT .
          - echo "Verifying Flask is in MCP image..."
          - docker run --rm $REGISTRY/mrrobot-mcp-server:latest pip list | grep -i flask || (echo "ERROR Flask not found!" && exit 1)
          - echo "Pushing image to ECR..."
          - docker push $REGISTRY/mrrobot-mcp-server:latest
          - docker push $REGISTRY/mrrobot-mcp-server:$BITBUCKET_COMMIT
          - echo "Docker image pushed successfully to DEV!"

    - step: &deploy-ecs-dev
        name: "Deploy to ECS (Dev)"
        script:
          - echo "Deploying to ECS Fargate (DEV)..."
          - curl -s "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "awscliv2.zip" && unzip -q awscliv2.zip && ./aws/install
          - export AWS_REGION="us-east-1"
          - export CLUSTER_NAME="mrrobot-ai-core-dev"
          - export SERVICE_NAME="mrrobot-mcp-server-dev"
          - export AWS_ACCESS_KEY_ID=$AWS_DEV_ID
          - export AWS_SECRET_ACCESS_KEY=$AWS_DEV_SECRET
          - echo "Updating MCP Server service..."
          - aws ecs update-service --cluster $CLUSTER_NAME --service $SERVICE_NAME --force-new-deployment --region $AWS_REGION > /dev/null
          - echo "ECS service updated! Waiting for deployment to stabilize..."
          - aws ecs wait services-stable --cluster $CLUSTER_NAME --services $SERVICE_NAME --region $AWS_REGION || echo "Warning - Service may still be deploying"
          - echo "DEV deployment complete!"
          - echo "Dashboard URL - https://ai-agent.mrrobot.dev"
          - echo "MCP Server URL - https://mcp.mrrobot.dev/sse"

    - step: &build-docker-images-prod
        name: "Build & Push Docker Images (Prod)"
        services:
          - docker
        script:
          - echo "Building Docker images for ECS Fargate (PROD)..."
          - curl -s "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "awscliv2.zip" && unzip -q awscliv2.zip && ./aws/install
          - export AWS_REGION="us-east-1"
          - export AWS_ACCOUNT_ID="246295362269"
          - export REGISTRY="${AWS_ACCOUNT_ID}.dkr.ecr.${AWS_REGION}.amazonaws.com"
          - export AWS_ACCESS_KEY_ID=$AWS_PROD_ID
          - export AWS_SECRET_ACCESS_KEY=$AWS_PROD_SECRET
          - aws ecr get-login-password --region $AWS_REGION | docker login --username AWS --password-stdin $REGISTRY
          - echo "Building MCP Server image (includes React dashboard)..."
          # Try multiple NPM token variables (different repos use different names)
          - |
            if [ -n "$JFROG_TOKEN" ]; then
              export NPM_BUILD_TOKEN="$JFROG_TOKEN"
              echo "Using JFROG_TOKEN"
            elif [ -n "$NPM_DEVOPS_AUTH_TOKEN" ]; then
              export NPM_BUILD_TOKEN="$NPM_DEVOPS_AUTH_TOKEN"
              echo "Using NPM_DEVOPS_AUTH_TOKEN"
            elif [ -n "$NPM_AUTH_TOKEN" ]; then
              export NPM_BUILD_TOKEN="$NPM_AUTH_TOKEN"
              echo "Using NPM_AUTH_TOKEN"
            elif [ -n "$NPM_TOKEN" ]; then
              export NPM_BUILD_TOKEN="$NPM_TOKEN"
              echo "Using NPM_TOKEN"
            else
              echo "ERROR: No NPM token found!"
              exit 1
            fi
            echo "Token length: ${#NPM_BUILD_TOKEN}"
          - docker build -f Dockerfile.mcp --build-arg NPM_TOKEN="$NPM_BUILD_TOKEN" -t $REGISTRY/mrrobot-mcp-server:latest -t $REGISTRY/mrrobot-mcp-server:$BITBUCKET_COMMIT .
          - echo "Verifying Flask is in MCP image..."
          - docker run --rm $REGISTRY/mrrobot-mcp-server:latest pip list | grep -i flask || (echo "ERROR Flask not found!" && exit 1)
          - echo "Pushing image to ECR..."
          - docker push $REGISTRY/mrrobot-mcp-server:latest
          - docker push $REGISTRY/mrrobot-mcp-server:$BITBUCKET_COMMIT
          - echo "Docker image pushed successfully to PROD!"

    - step: &deploy-ecs-prod
        name: "Deploy to ECS (Prod)"
        script:
          - echo "Deploying to ECS Fargate (PROD)..."
          - curl -s "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "awscliv2.zip" && unzip -q awscliv2.zip && ./aws/install
          - export AWS_REGION="us-east-1"
          - export CLUSTER_NAME="mrrobot-ai-core-prod"
          - export SERVICE_NAME="mrrobot-mcp-server-prod"
          - export AWS_ACCESS_KEY_ID=$AWS_PROD_ID
          - export AWS_SECRET_ACCESS_KEY=$AWS_PROD_SECRET
          - echo "Updating MCP Server service..."
          - aws ecs update-service --cluster $CLUSTER_NAME --service $SERVICE_NAME --force-new-deployment --region $AWS_REGION > /dev/null
          - echo "ECS service updated! Waiting for deployment to stabilize..."
          - aws ecs wait services-stable --cluster $CLUSTER_NAME --services $SERVICE_NAME --region $AWS_REGION || echo "Warning - Service may still be deploying"
          - echo "PROD deployment complete!"
          - echo "Dashboard URL - https://ai-agent.nex.io"
          - echo "MCP Server URL - https://mcp.nex.io/sse"

options:
  size: 2x

pipelines:
  branches:
    "**":
      - parallel:
          - step: *pre-commit
          - step: *python-lint

    main:
      - parallel:
          - step: *pre-commit
          - step: *python-lint
      # Deploy to Dev
      - step: *build-docker-images-dev
      - step: *deploy-ecs-dev
      # Deploy to Prod (after Dev succeeds)
      - step: *build-docker-images-prod
      - step: *deploy-ecs-prod

  custom:
    deploy-dev:
      - step: *build-docker-images-dev
      - step: *deploy-ecs-dev

    deploy-prod:
      - step: *build-docker-images-prod
      - step: *deploy-ecs-prod

    deploy-all:
      - step: *build-docker-images-dev
      - step: *deploy-ecs-dev
      - step: *build-docker-images-prod
      - step: *deploy-ecs-prod
